C51 COMPILER V9.60.7.0   DS1302                                                            08/02/2025 08:52:34 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN .\Objects\DS1302.obj
COMPILER INVOKED BY: C:\keil_C51\C51\BIN\C51.EXE DS1302.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\D
                    -S1302.lst) TABS(2) OBJECT(.\Objects\DS1302.obj)

line level    source

   1          #include "DS1302.h"
   2          
   3          // 寄存器地址（内部常量，不暴露）
   4          #define DS1302_SECOND   0x80
   5          #define DS1302_MINUTE   0x82
   6          #define DS1302_HOUR     0x84
   7          #define DS1302_DATE     0x86
   8          #define DS1302_MONTH    0x88
   9          #define DS1302_DAY      0x8A
  10          #define DS1302_YEAR     0x8C
  11          #define DS1302_WP     0x8E
  12          
  13          // 时间数组
  14          unsigned char DS1302_Time[] = {25, 8, 2, 00, 00, 00, 6};  // 年/月/日/时/分/秒/星期
  15          
  16          // 内部辅助函数（静态，仅本文件可见）
  17          static unsigned char dec_to_bcd(unsigned char dec);  // 十进制转BCD
  18          static unsigned char bcd_to_dec(unsigned char bcd);  // BCD转十进制
  19          
  20          
  21          /**
  22           * 初始化DS1302
  23           */
  24          void DS1302_Init(void){
  25   1        DS1302_CE = 0;
  26   1        DS1302_SCLK = 0;
  27   1      }
  28          
  29          
  30          /**
  31           * 写入字节到DS1302
  32           * @param Command：寄存器地址
  33           * @param Data：要写入的数据
  34           */
  35          void DS1302_WriteByte(unsigned char Command, unsigned char Data){
  36   1        unsigned char i;
  37   1        DS1302_CE = 1;  // 使能芯片
  38   1        
  39   1        // 写入地址（低位在前）
  40   1        for(i = 0; i < 8; i++){
  41   2          DS1302_IO = (Command >> i) & 0x01;  // 取第i位
  42   2          DS1302_SCLK = 1;  // 时钟上升沿写入
  43   2          DS1302_SCLK = 0;
  44   2        }
  45   1        
  46   1        // 写入数据（低位在前）
  47   1        for(i = 0; i < 8; i++){
  48   2          DS1302_IO = (Data >> i) & 0x01;  // 取第i位
  49   2          DS1302_SCLK = 1;  // 时钟上升沿写入
  50   2          DS1302_SCLK = 0;
  51   2        }
  52   1        
  53   1        DS1302_CE = 0;  // 禁用芯片
  54   1      }
C51 COMPILER V9.60.7.0   DS1302                                                            08/02/2025 08:52:34 PAGE 2   

  55          
  56          
  57          /**
  58           * 从DS1302读取字节
  59           * @param Command：寄存器地址
  60           * @return 读取到的数据
  61           */
  62          unsigned char DS1302_ReadByte(unsigned char Command){
  63   1        unsigned char i, Data = 0;
  64   1        Command |= 0x01;  // 读操作需置位最低位
  65   1        DS1302_CE = 1;    // 使能芯片
  66   1        
  67   1        // 写入地址（低位在前）
  68   1        for(i = 0; i < 8; i++){
  69   2          DS1302_IO = (Command >> i) & 0x01;  // 取第i位
  70   2          DS1302_SCLK = 0;
  71   2          DS1302_SCLK = 1;  // 时钟下降沿准备读取
  72   2        }
  73   1        
  74   1        // 读取数据（低位在前）
  75   1        for(i = 0; i < 8; i++){
  76   2          DS1302_SCLK = 1;
  77   2          DS1302_SCLK = 0;  // 时钟下降沿读取
  78   2          if(DS1302_IO) Data |= (1 << i);  // 保存第i位
  79   2        }
  80   1        
  81   1        DS1302_CE = 0;    // 禁用芯片
  82   1        DS1302_IO = 0;    // 复位IO口
  83   1        return Data;
  84   1      }
  85          
  86          
  87          /**
  88           * 设置时间
  89           * 功能：将DS1302_Time数组的时间写入芯片
  90           */
  91          void DS1302_SetTime(void){
  92   1        // 关闭写保护
  93   1        DS1302_WriteByte(DS1302_WP, 0x00);
  94   1        
  95   1        // 十进制转BCD后写入
  96   1        DS1302_WriteByte(DS1302_YEAR, dec_to_bcd(DS1302_Time[0]));
  97   1        DS1302_WriteByte(DS1302_MONTH, dec_to_bcd(DS1302_Time[1]));
  98   1        DS1302_WriteByte(DS1302_DATE, dec_to_bcd(DS1302_Time[2]));
  99   1        DS1302_WriteByte(DS1302_HOUR, dec_to_bcd(DS1302_Time[3]));
 100   1        DS1302_WriteByte(DS1302_MINUTE, dec_to_bcd(DS1302_Time[4]));
 101   1        DS1302_WriteByte(DS1302_SECOND, dec_to_bcd(DS1302_Time[5]));
 102   1        DS1302_WriteByte(DS1302_DAY, dec_to_bcd(DS1302_Time[6]));
 103   1        
 104   1        // 打开写保护
 105   1        DS1302_WriteByte(DS1302_WP, 0x80);
 106   1      }
 107          
 108          
 109          /**
 110           * 读取时间
 111           * 功能：从芯片读取时间到DS1302_Time数组
 112           */
 113          void DS1302_ReadTime(void){
 114   1        unsigned char temp;
 115   1        
 116   1        // 读取BCD码并转为十进制
C51 COMPILER V9.60.7.0   DS1302                                                            08/02/2025 08:52:34 PAGE 3   

 117   1        temp = DS1302_ReadByte(DS1302_YEAR);
 118   1        DS1302_Time[0] = bcd_to_dec(temp);
 119   1        
 120   1        temp = DS1302_ReadByte(DS1302_MONTH);
 121   1        DS1302_Time[1] = bcd_to_dec(temp);
 122   1        
 123   1        temp = DS1302_ReadByte(DS1302_DATE);
 124   1        DS1302_Time[2] = bcd_to_dec(temp);
 125   1        
 126   1        temp = DS1302_ReadByte(DS1302_HOUR);
 127   1        DS1302_Time[3] = bcd_to_dec(temp);
 128   1        
 129   1        temp = DS1302_ReadByte(DS1302_MINUTE);
 130   1        DS1302_Time[4] = bcd_to_dec(temp);
 131   1        
 132   1        temp = DS1302_ReadByte(DS1302_SECOND);
 133   1        DS1302_Time[5] = bcd_to_dec(temp);
 134   1        
 135   1        temp = DS1302_ReadByte(DS1302_DAY);
 136   1        DS1302_Time[6] = bcd_to_dec(temp);
 137   1      }
 138          
 139          
 140          /**
 141           * 内部辅助函数：十进制转BCD码（如25 → 0x25）
 142           */
 143          static unsigned char dec_to_bcd(unsigned char dec){
 144   1        return (dec / 10) << 4 | (dec % 10);
 145   1      }
 146          
 147          
 148          /**
 149           * 内部辅助函数：BCD码转十进制（如0x25 → 25）
 150           */
 151          static unsigned char bcd_to_dec(unsigned char bcd){
 152   1        return (bcd >> 4) * 10 + (bcd & 0x0F);
 153   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    318    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
