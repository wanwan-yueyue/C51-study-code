C51 COMPILER V9.60.7.0   MATRIXKEY                                                         08/13/2025 23:02:00 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MATRIXKEY
OBJECT MODULE PLACED IN .\Objects\MatrixKey.obj
COMPILER INVOKED BY: C:\keil_C51\C51\BIN\C51.EXE MatrixKey.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listing
                    -s\MatrixKey.lst) TABS(2) OBJECT(.\Objects\MatrixKey.obj)

line level    source

   1          #include <REGX52.H>
   2          #include "delay.h"
   3          
   4          // 列选信号数组，依次选中第1-4列
   5          static unsigned char code ColPins[] = {0x08, 0x04, 0x02, 0x01};
   6          // 按键值映射表，对应行列交叉点的按键编号
   7          static unsigned char code KeyMap[4][4] = {
   8              {1 ,  2,  3,  4},
   9              {5 ,  6,  7,  8},
  10              {9 , 10, 11, 12},
  11              {13, 14, 15, 16}
  12          };
  13          
  14          /**
  15           * @brief 读取矩阵键盘按键值
  16           * @return 按键值(1-16)，无按键按下时返回0
  17           */
  18          unsigned char MatrixKey(void) {
  19   1          unsigned char col, row;
  20   1          unsigned char KeyNumber = 0;
  21   1          unsigned char rowVal;
  22   1          
  23   1          // 依次扫描每一列
  24   1          for(col = 0; col < 4; col++) {
  25   2              // 先将所有列置高，再将当前列置低
  26   2              P1 = 0xFF;
  27   2              P1 &= ~ColPins[col];
  28   2              
  29   2              // 读取行状态
  30   2              rowVal = (P1 >> 4) & 0x0F; // 取P1_7-P1_4的值
  31   2              
  32   2              // 检测每一行
  33   2              for(row = 0; row < 4; row++) {
  34   3                  // 判断当前行是否有按键按下
  35   3                  if(!(rowVal & (1 << (3 - row)))) {
  36   4                      Delay1ms(20); // 消抖
  37   4                      
  38   4                      // 再次确认按键按下
  39   4                      if(!(rowVal & (1 << (3 - row)))) {
  40   5                          // 等待按键释放
  41   5                          while(!(rowVal & (1 << (3 - row)))) {
  42   6                              rowVal = (P1 >> 4) & 0x0F;
  43   6                          }
  44   5                          Delay1ms(20); // 消抖
  45   5                          
  46   5                          // 获取对应的按键值
  47   5                          KeyNumber = KeyMap[row][col];
  48   5                          
  49   5                          // 退出所有循环，一次只处理一个按键
  50   5                          col = 4;
  51   5                          row = 4;
  52   5                      }
  53   4                  }
  54   3              }
C51 COMPILER V9.60.7.0   MATRIXKEY                                                         08/13/2025 23:02:00 PAGE 2   

  55   2          }
  56   1          
  57   1          return KeyNumber;
  58   1      }
  59              


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    196    ----
   CONSTANT SIZE    =     20    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
